<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NCI Gadi HPC Service Unit (SU) Calculator — Wolf Sigma Dark Theme</title>

  <style>
    :root {
      --wolf-1: #3838B2; /* Early Spring Night */
      --wolf-2: #404086; /* Jacksons Purple */
      --wolf-3: #1F1FDB; /* Bluebonnet (highlight) */
      --wolf-4: #3B3B5C; /* Magic Night (cards) */
      --wolf-5: #292933; /* Night Sky (background) */
      --wolf-6: #2A2A33; /* Deep Well (tab bar) */

      --text-light: #ECECF5;
      --text-mid: #C5C5D6;
      --border-light: #4A4A5A;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: var(--text-light);
      background-color: var(--wolf-5);
    }

    /* ==================== TABS ==================== */
    .tab-container {
      margin-bottom: 20px;
      display: flex;
      background-color: var(--wolf-6);
      border-bottom: 2px solid var(--wolf-2);
      border-radius: 6px 6px 0 0;
      overflow: hidden;
    }

    .tab {
      padding: 14px 24px;
      cursor: pointer;
      border: none;
      background-color: var(--wolf-6);
      color: var(--text-mid);
      font-size: 16px;
      font-weight: 600;
      transition: 0.2s ease;
      border-bottom: 4px solid transparent;
    }

    .tab:hover {
      background-color: #343446;
      color: var(--text-light);
    }

    .tab.active {
      color: var(--text-light);
      border-bottom: 4px solid var(--wolf-3);
      background-color: #35354A;
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* ==================== CALCULATOR BOXES ==================== */
    .calculator {
      background-color: var(--wolf-4);
      border-radius: 8px;
      padding: 25px;
      margin-top: 0;
      box-shadow: 0 4px 18px rgba(0,0,0,0.25);
      border: 1px solid var(--wolf-2);
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-light);
    }

    input[type="number"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      background-color: #2A2A33;
      color: var(--text-light);
      font-size: 16px;
    }

    button {
      background-color: var(--wolf-3);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: 0.2s ease;
    }

    button:hover {
      background-color: var(--wolf-1);
    }

    /* ==================== RESULTS ==================== */
    .result {
      margin-top: 24px;
      padding: 20px;
      background-color: #2A2A33;
      border-radius: 8px;
      border: 1px solid var(--wolf-2);
    }

    .formula {
      margin-top: 16px;
      padding: 12px 16px;
      background-color: #1E1E26;
      border-left: 4px solid var(--wolf-1);
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-mid);
      white-space: pre-line;
    }

    .block-warning {
      color: #FFD1D1;
      background-color: #7C1F1F;
      padding: 12px;
      margin-top: 24px;
      border-radius: 6px;
      font-weight: bold;
      display: none;
      border: 1px solid #CC4444;
    }
  </style>
</head>

<body>

<!-- ========================================================= -->
<!--                           TABS                             -->
<!-- ========================================================= -->
<div class="tab-container">
  <button class="tab active" onclick="openTab(event, 'tab1')">Standard SU Calculator</button>
  <button class="tab" onclick="openTab(event, 'tab2')">Parallel Task Calculator</button>
</div>

<!-- ========================================================= -->
<!--                    TAB 1: STANDARD SU                      -->
<!-- ========================================================= -->
<div id="tab1" class="tab-content active">
  <div class="calculator">
    <h2 style="color:white;">NCI Gadi HPC SU Calculator</h2>

    <div class="form-group">
      <label>Queue:</label>
      <select id="queue" onchange="updateHelpText()">
        <option value="normal">normal</option>
        <option value="express">express</option>
        <option value="hugemem">hugemem</option>
        <option value="megamem">megamem</option>

        <option value="normalbw">normalbw</option>
        <option value="expressbw">expressbw</option>
        <option value="hugemembw">hugemembw</option>
        <option value="megamembw">megamembw</option>

        <option value="normalsl">normalsl</option>
        <option value="normalsr">normalsr</option>
        <option value="expresssr">expresssr</option>

        <option value="gpuvolta">gpuvolta</option>
        <option value="dgxa100">dgxa100</option>

        <option value="copyq">copyq</option>
      </select>
    </div>

    <div class="form-group">
      <label>Cores per node:</label>
      <input type="number" id="cores" value="48">
      <small id="cores-help-text" style="color:var(--text-mid);"></small>
    </div>

    <div class="form-group">
      <label>Memory (GB):</label>
      <input type="number" id="memory" value="128">
    </div>

    <div class="form-group">
      <label>Nodes:</label>
      <input type="number" id="nodes" value="1">
    </div>

    <div class="form-group">
      <label>Walltime (hours):</label>
      <input type="number" id="hours" value="1" step="0.1">
    </div>

    <div class="form-group">
      <label>GPUs (optional):</label>
      <input type="number" id="gpus" value="0">
    </div>

    <button id="calculateBtn">Calculate</button>

    <div class="block-warning" id="hard-error"></div>

    <div class="result" id="result">
      <h3>Estimated SU Usage</h3>
      <p id="su-output"></p>
      <p id="details"></p>

      <div class="formula">
CPU jobs:
SU = rate × (cores × nodes) × walltimeHours

GPU jobs:
SU = rate × (GPUs × nodes) × walltimeHours
      </div>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!--                  TAB 2: PARALLEL TASKS                     -->
<!-- ========================================================= -->
<div id="tab2" class="tab-content">
  <div class="calculator">
    <h2 style="color:white;">Parallel Task SU Calculator</h2>

    <div class="form-group">
      <label>Hours per task:</label>
      <input type="number" id="pt_hours" value="0.1" step="0.01">
    </div>

    <div class="form-group">
      <label>CPUs per task:</label>
      <input type="number" id="pt_cpus" value="6">
    </div>

    <div class="form-group">
      <label>Queue:</label>
      <select id="pt_queue">
        <option value="normal">normal</option>
        <option value="express">express</option>
        <option value="hugemem">hugemem</option>
        <option value="megamem">megamem</option>

        <option value="normalbw">normalbw</option>
        <option value="expressbw">expressbw</option>
        <option value="hugemembw">hugemembw</option>
        <option value="megamembw">megamembw</option>

        <option value="normalsl">normalsl</option>
        <option value="normalsr">normalsr</option>
        <option value="expresssr">expresssr</option>

        <option value="gpuvolta">gpuvolta</option>
        <option value="dgxa100">dgxa100</option>

        <option value="copyq">copyq</option>
      </select>
    </div>

    <div class="form-group">
      <label>Total number of tasks:</label>
      <input type="number" id="pt_total_tasks" value="4000">
    </div>

    <div class="form-group">
      <label>Number of nodes:</label>
      <input type="number" id="pt_nodes" value="250">
    </div>

    <div class="form-group">
      <label>Walltime buffer (%):</label>
      <select id="pt_buffer">
        <option value="1.0">No buffer (0%)</option>
        <option value="1.25">+25%</option>
        <option value="1.5" selected>+50%</option>
        <option value="2.0">+100%</option>
      </select>
    </div>

    <button onclick="calculateParallelTasks()">Calculate</button>

    <div class="result" id="pt_result">
      <h3>Parallel Task SU Usage</h3>
      <p id="pt_su_output"></p>
      <p id="pt_details"></p>

      <div class="formula">
<strong>Calculation Details:</strong>

Tasks at once: <span id="f_tasksAtOnce"></span>
Number of batches: <span id="f_batches"></span>
Estimated walltime: <span id="f_estHours"></span> hours
Requested walltime (buffered): <span id="f_reqHours"></span> hours
Total SU: <span id="f_totalSU"></span>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!--                     JAVASCRIPT LOGIC                       -->
<!-- ========================================================= -->
<script>
/* TAB HANDLING — FIXED VERSION */
function openTab(event, tabId) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

  event.target.classList.add("active");
  document.getElementById(tabId).classList.add("active");
}

/* SHARED QUEUE PARAMETERS */
const QUEUE_PARAMS = {
  normal: { rate: 2.0, cores: 48, mem: 192 },
  express: { rate: 6.0, cores: 48, mem: 192 },
  hugemem: { rate: 3.0, cores: 48, mem: 3072 },
  megamem: { rate: 5.0, cores: 48, mem: 6144 },

  normalbw: { rate: 1.25, cores: 28, mem: 128 },
  expressbw: { rate: 3.75, cores: 28, mem: 128 },
  hugemembw: { rate: 1.25, cores: 28, mem: 1020 },
  megamembw: { rate: 1.25, cores: 64, mem: 3000 },

  normalsl: { rate: 1.5, cores: 36, mem: 192 },
  normalsr: { rate: 2.0, cores: 104, mem: 192 },
  expresssr: { rate: 6.0, cores: 104, mem: 192 },

  gpuvolta: { rate: 3.0, cores: 48, mem: 384 },
  dgxa100: { rate: 4.5, cores: 128, mem: 2000 },

  copyq: { rate: 2.0, cores: 1, mem: 190 }
};

/* STANDARD SU CALCULATOR */
document.getElementById("calculateBtn").addEventListener("click", function () {
  const queue = document.getElementById("queue").value;
  const cores = parseFloat(document.getElementById("cores").value);
  const nodes = parseFloat(document.getElementById("nodes").value);
  const hours = parseFloat(document.getElementById("hours").value);
  const gpus = parseFloat(document.getElementById("gpus").value);

  const q = QUEUE_PARAMS[queue];

  if (cores > q.cores) {
    document.getElementById("hard-error").style.display = "block";
    document.getElementById("hard-error").innerText =
      `❌ ${cores} cores exceeds max ${q.cores} for '${queue}'.`;
    document.getElementById("result").style.display = "none";
    return;
  }
  document.getElementById("hard-error").style.display = "none";

  let su;
  if (gpus > 0 && (queue === "gpuvolta" || queue === "dgxa100")) {
    su = q.rate * gpus * nodes * hours;
  } else {
    su = q.rate * cores * nodes * hours;
  }

  document.getElementById("su-output").innerText = `${su.toFixed(2)} SUs`;
  document.getElementById("details").innerText =
    `Queue: ${queue}, Cores: ${cores}, Nodes: ${nodes}, Walltime: ${hours} hrs`;

  document.getElementById("result").style.display = "block";
});

/* PARALLEL TASK CALCULATOR */
function calculateParallelTasks() {
  const hoursPerTask = parseFloat(document.getElementById("pt_hours").value);
  const cpusPerTask = parseFloat(document.getElementById("pt_cpus").value);
  const queue = document.getElementById("pt_queue").value;
  const totalTasks = parseFloat(document.getElementById("pt_total_tasks").value);
  const nodes = parseFloat(document.getElementById("pt_nodes").value);
  const buffer = parseFloat(document.getElementById("pt_buffer").value);

  const q = QUEUE_PARAMS[queue];

  const tasksAtOnce = Math.floor((nodes * q.cores) / cpusPerTask);
  const batches = totalTasks / tasksAtOnce;

  const estHours = hoursPerTask * batches;
  const reqHours = estHours * buffer;

  const totalCores = nodes * q.cores;
  const totalSU = q.rate * totalCores * reqHours;
  const totalKSU = totalSU / 1000;

  document.getElementById("pt_su_output").innerText =
    `${totalSU.toFixed(2)} SUs (${totalKSU.toFixed(3)} KSU)`;

  document.getElementById("pt_details").innerText =
    `Queue: ${queue}, Tasks at once: ${tasksAtOnce}, Batches: ${batches.toFixed(2)}, Requested walltime: ${reqHours.toFixed(2)} hrs`;

  // Formula breakdown
  document.getElementById("f_tasksAtOnce").innerText = tasksAtOnce;
  document.getElementById("f_batches").innerText = batches.toFixed(2);
  document.getElementById("f_estHours").innerText = estHours.toFixed(2);
  document.getElementById("f_reqHours").innerText = reqHours.toFixed(2);
  document.getElementById("f_totalSU").innerText = totalSU.toFixed(2);

  document.getElementById("pt_result").style.display = "block";
}
</script>

</body>
</html>
